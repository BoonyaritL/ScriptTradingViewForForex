//@version=5
strategy("⚡ Scalping EMA Strategy", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, pyramiding=0)

// === Input Parameters for Scalping ===
shortEmaLen = input.int(5, title="Fast EMA", minval=1, maxval=10)
longEmaLen = input.int(13, title="Slow EMA", minval=5, maxval=25)
rsiLen = input.int(9, title="RSI Length", minval=5, maxval=20)
rsiOverbought = input.int(75, title="RSI Overbought", minval=70, maxval=85)
rsiOversold = input.int(25, title="RSI Oversold", minval=15, maxval=30)

// Scalping specific settings
atrPeriod = input.int(10, title="ATR Period", minval=5, maxval=20)
atrMultSL = input.float(1.5, title="Stop Loss ATR Multiplier", minval=1.0, maxval=3.0, step=0.1)
atrMultTP = input.float(2.0, title="Take Profit ATR Multiplier", minval=1.0, maxval=4.0, step=0.1)
volumeMultiplier = input.float(1.3, title="Volume Multiplier", minval=1.0, maxval=3.0, step=0.1)

// Higher timeframe trend filter
htfTimeframe = input.timeframe("15", title="Higher Timeframe for Trend")
useHTFFilter = input.bool(true, title="Use Higher Timeframe Trend Filter")

// === Technical Indicators ===
fastEma = ta.ema(close, shortEmaLen)
slowEma = ta.ema(close, longEmaLen)
rsi = ta.rsi(close, rsiLen)
atr = ta.atr(atrPeriod)

// Volume analysis
volumeMA = ta.sma(volume, 10)
highVolume = volume > volumeMA * volumeMultiplier

// Higher timeframe trend
htfClose = request.security(syminfo.tickerid, htfTimeframe, close)
htfFastEma = request.security(syminfo.tickerid, htfTimeframe, ta.ema(close, shortEmaLen))
htfSlowEma = request.security(syminfo.tickerid, htfTimeframe, ta.ema(close, longEmaLen))
htfUpTrend = htfFastEma > htfSlowEma and htfClose > htfFastEma
htfDownTrend = htfFastEma < htfSlowEma and htfClose < htfFastEma

// === Scalping Conditions ===
// Basic EMA crossover
emaBullCross = ta.crossover(fastEma, slowEma)
emaBearCross = ta.crossunder(fastEma, slowEma)

// EMA alignment for trend
emaAlignedUp = fastEma > slowEma and close > fastEma
emaAlignedDown = fastEma < slowEma and close < fastEma

// RSI conditions for scalping
rsiGoodForBuy = rsi > 40 and rsi < rsiOverbought
rsiGoodForSell = rsi < 60 and rsi > rsiOversold
rsiMomentumUp = rsi > rsi[1] and rsi > 50
rsiMomentumDown = rsi < rsi[1] and rsi < 50

// Price action
bullishCandle = close > open and (close - open) > (high - low) * 0.5
bearishCandle = close < open and (open - close) > (high - low) * 0.5

// Momentum confirmation
priceAboveEMA = close > fastEma and close > slowEma
priceBelowEMA = close < fastEma and close < slowEma

// === SCALPING SIGNALS ===
// Quick scalp buy (short term)
quickBuy = emaBullCross and rsiGoodForBuy and (not useHTFFilter or htfUpTrend)
quickSell = emaBearCross and rsiGoodForSell and (not useHTFFilter or htfDownTrend)

// Strong scalp signals (better quality)
strongScalpBuy = emaBullCross and emaAlignedUp and rsiMomentumUp and bullishCandle and 
                 highVolume and (not useHTFFilter or htfUpTrend)
strongScalpSell = emaBearCross and emaAlignedDown and rsiMomentumDown and bearishCandle and 
                  highVolume and (not useHTFFilter or htfDownTrend)

// Momentum continuation signals
momentumBuy = emaAlignedUp and priceAboveEMA and rsiMomentumUp and bullishCandle and 
              rsi > 55 and rsi < 75 and (not useHTFFilter or htfUpTrend)
momentumSell = emaAlignedDown and priceBelowEMA and rsiMomentumDown and bearishCandle and 
               rsi < 45 and rsi > 25 and (not useHTFFilter or htfDownTrend)

// === Strategy Execution ===
var float entryPrice = na
var float stopLoss = na
var float takeProfit = na

// Strong Scalp Signals (primary)
if (strongScalpBuy and strategy.position_size == 0)
    entryPrice := close
    stopLoss := entryPrice - (atr * atrMultSL)
    takeProfit := entryPrice + (atr * atrMultTP)
    strategy.entry("SCALP_LONG", strategy.long, comment="Strong Scalp Buy")
    strategy.exit("EXIT_SCALP_LONG", "SCALP_LONG", stop=stopLoss, limit=takeProfit)

if (strongScalpSell and strategy.position_size == 0)
    entryPrice := close
    stopLoss := entryPrice + (atr * atrMultSL)
    takeProfit := entryPrice - (atr * atrMultTP)
    strategy.entry("SCALP_SHORT", strategy.short, comment="Strong Scalp Sell")
    strategy.exit("EXIT_SCALP_SHORT", "SCALP_SHORT", stop=stopLoss, limit=takeProfit)

// Quick Scalp Signals (secondary)
if (quickBuy and not strongScalpBuy and strategy.position_size == 0)
    entryPrice := close
    stopLoss := entryPrice - (atr * atrMultSL * 0.8)
    takeProfit := entryPrice + (atr * atrMultTP * 0.8)
    strategy.entry("QUICK_LONG", strategy.long, comment="Quick Buy")
    strategy.exit("EXIT_QUICK_LONG", "QUICK_LONG", stop=stopLoss, limit=takeProfit)

if (quickSell and not strongScalpSell and strategy.position_size == 0)
    entryPrice := close
    stopLoss := entryPrice + (atr * atrMultSL * 0.8)
    takeProfit := entryPrice - (atr * atrMultTP * 0.8)
    strategy.entry("QUICK_SHORT", strategy.short, comment="Quick Sell")
    strategy.exit("EXIT_QUICK_SHORT", "QUICK_SHORT", stop=stopLoss, limit=takeProfit)

// === Plotting ===
plot(fastEma, color=color.yellow, title="Fast EMA", linewidth=2)
plot(slowEma, color=color.blue, title="Slow EMA", linewidth=2)

// Background colors for trend
bgcolor(emaAlignedUp ? color.new(color.green, 90) : emaAlignedDown ? color.new(color.red, 90) : na, title="EMA Trend")

// === SCALPING SIGNALS DISPLAY ===
// Strong Scalp Signals
plotshape(strongScalpBuy, title="🚀 STRONG SCALP BUY", location=location.belowbar, 
          color=color.new(color.lime, 0), style=shape.labelup, 
          text="🚀\nSTRONG\nSCALP", textcolor=color.black, size=size.normal)

plotshape(strongScalpSell, title="💥 STRONG SCALP SELL", location=location.abovebar, 
          color=color.new(color.red, 0), style=shape.labeldown, 
          text="💥\nSTRONG\nSCALP", textcolor=color.white, size=size.normal)

// Quick Scalp Signals
plotshape(quickBuy and not strongScalpBuy, title="⚡ QUICK BUY", location=location.belowbar, 
          color=color.new(color.green, 0), style=shape.triangleup, 
          text="⚡", textcolor=color.white, size=size.small)

plotshape(quickSell and not strongScalpSell, title="⚡ QUICK SELL", location=location.abovebar, 
          color=color.new(color.maroon, 0), style=shape.triangledown, 
          text="⚡", textcolor=color.white, size=size.small)

// Momentum Continuation (for reference)
plotshape(momentumBuy, title="➡️ MOMENTUM", location=location.belowbar, 
          color=color.new(color.orange, 0), style=shape.arrowup, 
          text="M", textcolor=color.white, size=size.tiny)

plotshape(momentumSell, title="⬅️ MOMENTUM", location=location.abovebar, 
          color=color.new(color.purple, 0), style=shape.arrowdown, 
          text="M", textcolor=color.white, size=size.tiny)

// Price levels
plot(strategy.position_size != 0 ? entryPrice : na, color=color.yellow, 
     style=plot.style_linebr, title="Entry", linewidth=1)
plot(strategy.position_size != 0 ? stopLoss : na, color=color.red, 
     style=plot.style_linebr, title="SL", linewidth=1)
plot(strategy.position_size != 0 ? takeProfit : na, color=color.green, 
     style=plot.style_linebr, title="TP", linewidth=1)

// === Information Table ===
var table scalpTable = table.new(position.top_right, 2, 8, bgcolor=color.white, border_width=1)
if barstate.islast
    table.cell(scalpTable, 0, 0, "⚡ SCALP STATUS", text_color=color.white, bgcolor=color.navy)
    table.cell(scalpTable, 1, 0, "", text_color=color.white, bgcolor=color.navy)
    
    table.cell(scalpTable, 0, 1, "Timeframe", text_color=color.black)
    table.cell(scalpTable, 1, 1, str.tostring(timeframe.period), text_color=color.blue)
    
    table.cell(scalpTable, 0, 2, "EMA Trend", text_color=color.black)
    table.cell(scalpTable, 1, 2, emaAlignedUp ? "UP" : emaAlignedDown ? "DOWN" : "FLAT", 
               text_color=emaAlignedUp ? color.green : emaAlignedDown ? color.red : color.gray)
    
    table.cell(scalpTable, 0, 3, "RSI", text_color=color.black)
    table.cell(scalpTable, 1, 3, str.tostring(math.round(rsi, 1)), 
               text_color=rsi > 70 ? color.red : rsi < 30 ? color.green : color.blue)
    
    table.cell(scalpTable, 0, 4, "Volume", text_color=color.black)
    table.cell(scalpTable, 1, 4, str.tostring(math.round(volume/volumeMA, 1)) + "x", 
               text_color=highVolume ? color.green : color.gray)
    
    table.cell(scalpTable, 0, 5, "HTF Trend", text_color=color.black)
    table.cell(scalpTable, 1, 5, htfUpTrend ? "UP" : htfDownTrend ? "DOWN" : "FLAT", 
               text_color=htfUpTrend ? color.green : htfDownTrend ? color.red : color.gray)
    
    table.cell(scalpTable, 0, 6, "Position", text_color=color.black)
    table.cell(scalpTable, 1, 6, strategy.position_size > 0 ? "LONG" : strategy.position_size < 0 ? "SHORT" : "FLAT", 
               text_color=strategy.position_size > 0 ? color.green : strategy.position_size < 0 ? color.red : color.gray)

// === Alerts ===
alertcondition(strongScalpBuy, title="STRONG SCALP BUY", message="Strong Scalp Buy Signal!")
alertcondition(strongScalpSell, title="STRONG SCALP SELL", message="Strong Scalp Sell Signal!")
alertcondition(quickBuy, title="QUICK BUY", message="Quick Buy Signal!")
alertcondition(quickSell, title="QUICK SELL", message="Quick Sell Signal!")